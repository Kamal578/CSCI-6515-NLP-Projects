<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Project 2 Results UI</title>
  <style>
    :root {
      --bg: #f5f0e8;
      --panel: rgba(255, 252, 246, 0.88);
      --ink: #1d1b1a;
      --muted: #6f685f;
      --accent: #0f766e;
      --accent-2: #c2410c;
      --danger: #c1121f;
      --line: rgba(29, 27, 26, 0.12);
      --shadow: 0 14px 40px rgba(40, 32, 18, 0.12);
      --radius: 18px;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      color: var(--ink);
      background:
        radial-gradient(circle at 12% 8%, rgba(15,118,110,0.18), transparent 38%),
        radial-gradient(circle at 90% 12%, rgba(194,65,12,0.16), transparent 35%),
        linear-gradient(180deg, #f8f4ec 0%, #efe6d7 100%);
      font-family: "Avenir Next", "Gill Sans", "Trebuchet MS", sans-serif;
      min-height: 100vh;
    }

    .shell {
      width: min(1200px, calc(100vw - 24px));
      margin: 12px auto 24px;
      padding: 14px;
    }

    .hero {
      background: linear-gradient(145deg, rgba(255,255,255,0.9), rgba(250,244,235,0.9));
      border: 1px solid var(--line);
      border-radius: 24px;
      box-shadow: var(--shadow);
      padding: 18px 18px 14px;
      margin-bottom: 14px;
    }

    .hero h1 {
      margin: 0;
      font-size: clamp(1.25rem, 2vw, 2rem);
      letter-spacing: 0.02em;
    }

    .hero p {
      margin: 8px 0 0;
      color: var(--muted);
      line-height: 1.35;
    }

    .status {
      margin-top: 10px;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      font-size: 0.92rem;
      color: var(--muted);
      padding: 8px 10px;
      border: 1px dashed var(--line);
      border-radius: 999px;
      background: rgba(255,255,255,0.55);
    }

    .dot {
      width: 10px; height: 10px; border-radius: 50%;
      background: #9ca3af;
      box-shadow: 0 0 0 4px rgba(156,163,175,0.18);
    }
    .dot.ok { background: var(--accent); box-shadow: 0 0 0 4px rgba(15,118,110,0.16); }
    .dot.bad { background: var(--danger); box-shadow: 0 0 0 4px rgba(193,18,31,0.16); }

    .layout {
      display: grid;
      grid-template-columns: 270px 1fr;
      gap: 14px;
    }

    .tabs {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-self: start;
      position: sticky;
      top: 12px;
    }

    .tab {
      appearance: none;
      border: 1px solid transparent;
      background: rgba(255,255,255,0.45);
      color: var(--ink);
      border-radius: 14px;
      padding: 12px;
      text-align: left;
      cursor: pointer;
      transition: 150ms ease;
    }
    .tab .title { display: block; font-weight: 700; }
    .tab .sub { display: block; color: var(--muted); font-size: 0.86rem; margin-top: 4px; }
    .tab:hover { transform: translateY(-1px); border-color: var(--line); }
    .tab.active {
      background: linear-gradient(145deg, rgba(15,118,110,0.14), rgba(255,255,255,0.85));
      border-color: rgba(15,118,110,0.22);
      box-shadow: inset 0 0 0 1px rgba(15,118,110,0.08);
    }

    .panel {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
      min-height: 540px;
    }

    .tab-panel { display: none; }
    .tab-panel.active { display: block; animation: fade 180ms ease-out; }
    @keyframes fade { from { opacity: 0; transform: translateY(3px);} to { opacity: 1; transform: translateY(0);} }

    .panel h2 {
      margin: 0 0 6px;
      font-size: 1.15rem;
    }
    .panel .hint {
      margin: 0 0 14px;
      color: var(--muted);
      line-height: 1.35;
    }

    .controls {
      display: grid;
      gap: 10px;
      margin-bottom: 12px;
    }

    .row {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items: center;
    }

    input[type="text"], textarea {
      width: 100%;
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 12px 13px;
      font: inherit;
      background: rgba(255,255,255,0.9);
      color: var(--ink);
    }
    textarea {
      min-height: 120px;
      resize: vertical;
      line-height: 1.35;
    }
    input:focus, textarea:focus {
      outline: none;
      border-color: rgba(15,118,110,0.45);
      box-shadow: 0 0 0 4px rgba(15,118,110,0.1);
    }

    .btn {
      appearance: none;
      border: none;
      border-radius: 12px;
      padding: 11px 14px;
      background: linear-gradient(135deg, #0f766e, #115e59);
      color: #fff;
      font-weight: 700;
      cursor: pointer;
      white-space: nowrap;
    }
    .btn.secondary {
      background: linear-gradient(135deg, #c2410c, #9a3412);
    }
    .btn:disabled { opacity: 0.55; cursor: wait; }

    .results {
      border: 1px solid var(--line);
      border-radius: 14px;
      background: rgba(255,255,255,0.7);
      padding: 12px;
      min-height: 90px;
    }

    .cards {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
    }

    .card {
      border: 1px solid var(--line);
      border-radius: 14px;
      background: rgba(255,255,255,0.88);
      padding: 10px;
    }
    .card h3 {
      margin: 0 0 8px;
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .pill {
      font-size: 0.72rem;
      color: #fff;
      background: #374151;
      border-radius: 999px;
      padding: 2px 8px;
    }
    .pill.warn { background: var(--accent-2); }

    .list {
      margin: 0;
      padding: 0;
      list-style: none;
      display: grid;
      gap: 6px;
    }
    .list li {
      border: 1px solid rgba(0,0,0,0.06);
      border-radius: 10px;
      padding: 7px 9px;
      background: rgba(248,248,248,0.75);
      display: flex;
      justify-content: space-between;
      gap: 10px;
    }

    .mono { font-family: "IBM Plex Mono", "SFMono-Regular", Consolas, monospace; }
    .muted { color: var(--muted); }
    .error { color: var(--danger); font-weight: 600; }
    .empty { color: var(--muted); font-style: italic; }

    .sentence-output {
      line-height: 1.55;
      font-size: 1rem;
      word-break: break-word;
    }
    .sentence-chip {
      display: inline;
      padding: 2px 0;
      background: transparent;
    }
    .boundary-period {
      color: var(--danger);
      font-weight: 900;
      font-size: 1.15em;
      margin: 0 6px 0 2px;
    }
    .boundary-sep {
      color: rgba(193,18,31,0.35);
      margin-right: 4px;
    }

    .typing-mode {
      margin-bottom: 10px;
      font-weight: 700;
      color: #1f2937;
    }
    .typing-grid {
      display: grid;
      gap: 10px;
      grid-template-columns: repeat(3, minmax(0, 1fr));
    }

    .helper-grid {
      display: grid;
      gap: 10px;
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
    .helper-grid input {
      padding: 10px 11px;
      font-size: 0.92rem;
    }
    .toggle-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 12px;
      color: var(--muted);
      font-size: 0.92rem;
    }
    .toggle-row label {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      color: var(--ink);
      font-weight: 600;
    }

    .kbd {
      font-family: "IBM Plex Mono", Consolas, monospace;
      background: rgba(0,0,0,0.05);
      border: 1px solid rgba(0,0,0,0.08);
      border-bottom-width: 2px;
      border-radius: 6px;
      padding: 2px 6px;
      font-size: 0.85em;
    }

    @media (max-width: 980px) {
      .layout { grid-template-columns: 1fr; }
      .tabs {
        position: static;
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
      .cards, .typing-grid { grid-template-columns: 1fr; }
      .helper-grid { grid-template-columns: 1fr; }
      .row { grid-template-columns: 1fr; }
      .btn { width: 100%; }
      .panel { min-height: auto; }
    }

    @media (prefers-reduced-motion: reduce) {
      * { transition: none !important; animation: none !important; }
    }
  </style>
</head>
<body>
  <div class="shell">
    <section class="hero">
      <h1>Project 2 Results UI Playground</h1>
      <p>
        Unified interface for spellchecking, n-gram next-word suggestions, sentence splitting, and real-time typing assistance.
        It reuses your existing tokenizer, sentence segmenter, and spellcheck logic.
      </p>
      <div class="status" id="uiStatus">
        <span class="dot" id="statusDot"></span>
        <span id="statusText">Checking backend status...</span>
      </div>
    </section>

    <div class="layout">
      <nav class="tabs" aria-label="Project 2 UI tabs">
        <button class="tab active" data-tab="spellchecker">
          <span class="title">Spellchecker</span>
          <span class="sub">Existing correction/suggestion engine</span>
        </button>
        <button class="tab" data-tab="ngrams">
          <span class="title">N-Grams Suggestions</span>
          <span class="sub">Top next-word options for 1/2/3-grams</span>
        </button>
        <button class="tab" data-tab="delimiter">
          <span class="title">Sentence Delimiter</span>
          <span class="sub">Split text into sentences with red boundary dots</span>
        </button>
        <button class="tab" data-tab="typing">
          <span class="title">Typing Assistance</span>
          <span class="sub">Real-time next-word or spell suggestions</span>
        </button>
      </nav>

      <main class="panel">
        <section class="tab-panel active" id="panel-spellchecker">
          <h2>Spellchecker</h2>
          <p class="hint">Uses the existing spellcheck logic (weighted edit distance if confusion weights are available).</p>
          <div class="controls">
            <div class="helper-grid">
              <input type="text" id="sharedCorpusPathSpell" value="data/raw/corpus.csv" aria-label="Corpus path" />
              <input type="text" id="spellInput" placeholder="Type a word, e.g. kompyuter" aria-label="Word to spellcheck" />
            </div>
            <div class="toggle-row">
              <label><input type="checkbox" id="spellUseConfusion" /> Use weighted confusion (slower, often better ranking)</label>
            </div>
            <div class="row">
              <div class="muted">Press <span class="kbd">Enter</span> or click to fetch top suggestions.</div>
              <button class="btn" id="spellBtn">Suggest</button>
            </div>
          </div>
          <div class="results" id="spellResults"></div>
        </section>

        <section class="tab-panel" id="panel-ngrams">
          <h2>N-Grams Suggestions</h2>
          <p class="hint">
            Enter context text. The UI shows top 3 next-word suggestions for unigram, bigram, and trigram contexts
            using a lazily built n-gram index from the corpus.
          </p>
          <div class="controls">
            <div class="helper-grid">
              <input type="text" id="sharedCorpusPathNgram" value="data/raw/corpus.csv" aria-label="Corpus path" />
              <input type="text" id="ngramTextColumn" value="text" aria-label="Text column" />
            </div>
            <textarea id="ngramInput" placeholder="Type some context, e.g. men bu gün"></textarea>
            <div class="row">
              <div class="muted">Optional index cap for faster demo startup: <span class="kbd">leave empty = full corpus</span></div>
              <button class="btn secondary" id="ngramBtn">Get Suggestions</button>
            </div>
            <input type="text" id="ngramMaxDocs" placeholder="Optional max docs for n-gram index (e.g. 5000)" />
          </div>
          <div class="results" id="ngramResults"></div>
        </section>

        <section class="tab-panel" id="panel-delimiter">
          <h2>Sentence Delimiter</h2>
          <p class="hint">
            Input text and see it split into sentences. Sentence boundaries are marked with a <span style="color:#c1121f;font-weight:900;">red period</span>.
          </p>
          <div class="controls">
            <textarea id="delimiterInput" placeholder="Paste text here..."></textarea>
            <div class="row">
              <div class="muted">Uses the project sentence segmenter.</div>
              <button class="btn" id="delimiterBtn">Split Sentences</button>
            </div>
          </div>
          <div class="results sentence-output" id="delimiterResults"></div>
        </section>

        <section class="tab-panel" id="panel-typing">
          <h2>Typing Assistance (Real-time Suggestions)</h2>
          <p class="hint">
            Playground behavior:
            <br />• If the last character is a space: show next-word suggestions (best 3-gram / 2-gram / 1-gram)
            <br />• Otherwise: show top 3 spellcheck suggestions for the current partial word.
          </p>
          <div class="controls">
            <div class="helper-grid">
              <input type="text" id="sharedCorpusPathTyping" value="data/raw/corpus.csv" aria-label="Corpus path" />
              <input type="text" id="typingTextColumn" value="text" aria-label="Text column" />
            </div>
            <div class="toggle-row">
              <label><input type="checkbox" id="typingUseConfusion" /> Use weighted confusion for typing spell suggestions</label>
              <span>Keep off for lower latency while typing.</span>
            </div>
            <textarea id="typingInput" placeholder="Start typing here... (real-time suggestions appear below)"></textarea>
          </div>
          <div class="results" id="typingResults"></div>
        </section>
      </main>
    </div>
  </div>

  <script>
    const state = {
      typingTimer: null,
      ngramCacheHintShown: false,
      typingRequestSeq: 0,
      typingAbortController: null,
    };

    function $(id) { return document.getElementById(id); }

    async function postJSON(url, payload, opts = {}) {
      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
        signal: opts.signal,
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data.error || JSON.stringify(data) || `HTTP ${res.status}`);
      return data;
    }

    function esc(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;");
    }

    function renderSuggestionList(items, emptyText = "No suggestions.") {
      if (!items || !items.length) return `<div class="empty">${esc(emptyText)}</div>`;
      return `<ul class="list">${
        items.map(i => `<li><span class="mono">${esc(i.token)}</span><span class="muted">count=${i.count ?? i.freq ?? "?"}</span></li>`).join("")
      }</ul>`;
    }

    function renderSpellCandidates(items) {
      if (!items || !items.length) return `<div class="empty">No candidates found.</div>`;
      return `<ul class="list">${
        items.map(i => `<li><span class="mono">${esc(i.token)}</span><span class="muted">freq=${i.freq}</span></li>`).join("")
      }</ul>`;
    }

    function renderNgramCards(sug) {
      const order = [
        ["3gram", "Best 3-gram"],
        ["2gram", "Best 2-gram"],
        ["1gram", "Best 1-gram"],
      ];
      return `<div class="cards">${
        order.map(([key, title]) => {
          const block = sug[key] || { items: [], context: [], fallback_used: false };
          const context = block.context?.length ? `context: ${block.context.map(esc).join(" ")}` : "no context";
          const pill = block.fallback_used ? `<span class="pill warn">fallback</span>` : `<span class="pill">direct</span>`;
          return `
            <section class="card">
              <h3><span>${title}</span>${pill}</h3>
              <div class="muted" style="margin-bottom:8px;font-size:0.85rem;">${context}</div>
              ${renderSuggestionList(block.items)}
            </section>
          `;
        }).join("")
      }</div>`;
    }

    function activateTab(tabName) {
      document.querySelectorAll(".tab").forEach(btn => btn.classList.toggle("active", btn.dataset.tab === tabName));
      document.querySelectorAll(".tab-panel").forEach(panel => panel.classList.toggle("active", panel.id === `panel-${tabName}`));
    }

    document.querySelectorAll(".tab").forEach(btn => {
      btn.addEventListener("click", () => activateTab(btn.dataset.tab));
    });

    function syncConfusionToggles(sourceId, targetId) {
      const src = $(sourceId);
      const dst = $(targetId);
      src.addEventListener("change", () => { dst.checked = src.checked; });
    }
    syncConfusionToggles("spellUseConfusion", "typingUseConfusion");
    syncConfusionToggles("typingUseConfusion", "spellUseConfusion");

    // Spellchecker tab
    async function runSpellchecker() {
      const word = $("spellInput").value.trim();
      const corpusPath = $("sharedCorpusPathSpell").value.trim() || "data/raw/corpus.csv";
      const out = $("spellResults");
      if (!word) {
        out.innerHTML = `<div class="empty">Enter a word first.</div>`;
        return;
      }
      $("spellBtn").disabled = true;
      out.textContent = "Loading suggestions...";
      try {
        const data = await postJSON("/api/spellchecker", {
          word,
          corpus_path: corpusPath,
          use_confusion: $("spellUseConfusion").checked,
        });
        out.innerHTML = `
          <div class="muted" style="margin-bottom:8px;">
            Vocab size: ${data.vocab_size ?? "?"} | weighted confusion: ${data.used_confusion ? "yes" : "no"}
          </div>
          ${renderSpellCandidates(data.candidates)}
        `;
      } catch (err) {
        out.innerHTML = `<div class="error">Error: ${esc(err.message)}</div>`;
      } finally {
        $("spellBtn").disabled = false;
      }
    }
    $("spellBtn").addEventListener("click", runSpellchecker);
    $("spellInput").addEventListener("keydown", (e) => { if (e.key === "Enter") runSpellchecker(); });

    // N-gram tab
    async function runNgrams() {
      const out = $("ngramResults");
      const payload = {
        text: $("ngramInput").value,
        corpus_path: $("sharedCorpusPathNgram").value.trim() || "data/raw/corpus.csv",
        text_column: $("ngramTextColumn").value.trim() || "text",
        max_docs_ngram: $("ngramMaxDocs").value.trim() || null,
      };
      $("ngramBtn").disabled = true;
      out.innerHTML = `<div class="muted">Building/using n-gram index and fetching suggestions...</div>`;
      try {
        const data = await postJSON("/api/ngram_suggestions", payload);
        out.innerHTML = `
          <div class="muted" style="margin-bottom:8px;">
            Indexed docs=${data.index_stats.num_docs_indexed}, sentences=${data.index_stats.num_sentences_indexed},
            tokens=${data.index_stats.num_tokens_indexed}, vocab=${data.index_stats.vocab_size}
          </div>
          <div class="muted" style="margin-bottom:10px;">Recent context tokens: <span class="mono">${esc((data.context_tokens || []).join(" ")) || "(none)"}</span></div>
          ${renderNgramCards(data.suggestions)}
        `;
      } catch (err) {
        out.innerHTML = `<div class="error">Error: ${esc(err.message)}</div>`;
      } finally {
        $("ngramBtn").disabled = false;
      }
    }
    $("ngramBtn").addEventListener("click", runNgrams);

    // Sentence delimiter tab
    async function runDelimiter() {
      const out = $("delimiterResults");
      const text = $("delimiterInput").value;
      if (!text.trim()) {
        out.innerHTML = `<div class="empty">Paste or type some text first.</div>`;
        return;
      }
      $("delimiterBtn").disabled = true;
      out.textContent = "Segmenting...";
      try {
        const data = await postJSON("/api/sentence_delimiter", { text });
        const sentences = data.sentences || [];
        if (!sentences.length) {
          out.innerHTML = `<div class="empty">No sentences produced.</div>`;
          return;
        }
        out.innerHTML = `
          <div class="muted" style="margin-bottom:8px;">Sentence count: ${data.sentence_count}</div>
          <div>
            ${sentences.map((s, i) => `
              <span class="sentence-chip">${esc(s)}</span>${i < sentences.length - 1 ? '<span class="boundary-sep">|</span><span class="boundary-period">.</span>' : ''}
            `).join("")}
          </div>
        `;
      } catch (err) {
        out.innerHTML = `<div class="error">Error: ${esc(err.message)}</div>`;
      } finally {
        $("delimiterBtn").disabled = false;
      }
    }
    $("delimiterBtn").addEventListener("click", runDelimiter);

    // Typing assistance tab (real-time)
    function scheduleTypingAssist() {
      clearTimeout(state.typingTimer);
      state.typingTimer = setTimeout(runTypingAssist, 260);
    }

    async function runTypingAssist() {
      const out = $("typingResults");
      const text = $("typingInput").value;
      const payload = {
        text,
        corpus_path: $("sharedCorpusPathTyping").value.trim() || "data/raw/corpus.csv",
        text_column: $("typingTextColumn").value.trim() || "text",
        use_confusion: $("typingUseConfusion").checked,
      };
      if (!text) {
        out.innerHTML = `<div class="empty">Start typing to see suggestions.</div>`;
        return;
      }
      out.innerHTML = `<div class="muted">Analyzing input...</div>`;
      const requestSeq = ++state.typingRequestSeq;
      if (state.typingAbortController) state.typingAbortController.abort();
      state.typingAbortController = new AbortController();
      try {
        const data = await postJSON("/api/typing_assist", payload, { signal: state.typingAbortController.signal });
        if (requestSeq !== state.typingRequestSeq) return;
        if (data.mode === "empty") {
          out.innerHTML = `<div class="empty">${esc(data.message || "No suggestions yet.")}</div>`;
          return;
        }
        if (data.mode === "spellcheck") {
          out.innerHTML = `
            <div class="typing-mode">Mode: Spellcheck suggestions (current token is incomplete)</div>
            <div class="muted" style="margin-bottom:8px;">Current token: <span class="mono">${esc(data.current_token || "")}</span> | weighted confusion: ${data.used_confusion ? "yes" : "no"}</div>
            ${data.message ? `<div class="muted" style="margin-bottom:8px;">${esc(data.message)}</div>` : ""}
            ${renderSpellCandidates(data.spell_suggestions || [])}
          `;
          return;
        }
        if (data.mode === "next_word") {
          out.innerHTML = `
            <div class="typing-mode">Mode: Next-word suggestions (last character is a space)</div>
            ${renderNgramCards(data.ngram_suggestions || {})}
            <div class="muted" style="margin-top:8px;">
              Indexed docs=${data.index_stats?.num_docs_indexed ?? "?"}, vocab=${data.index_stats?.vocab_size ?? "?"}
            </div>
          `;
          return;
        }
        out.innerHTML = `<div class="empty">Unhandled mode.</div>`;
      } catch (err) {
        if (err.name === "AbortError") return;
        out.innerHTML = `<div class="error">Error: ${esc(err.message)}</div>`;
      }
    }
    $("typingInput").addEventListener("input", scheduleTypingAssist);

    async function refreshStatus() {
      const dot = $("statusDot");
      const text = $("statusText");
      try {
        const res = await fetch("/api/ui_status");
        const data = await res.json();
        if (data.corpus_exists) {
          dot.className = "dot ok";
          text.textContent = `Backend ready • corpus found • confusion file=${data.confusion_exists ? "yes" : "no"} • spell vocab cached=${data.spell_vocab_cached ? "yes" : "no"} • n-gram cache loaded=${data.ngram_index_cached ? "yes" : "no"}`;
        } else {
          dot.className = "dot bad";
          text.textContent = `Backend reachable but corpus file was not found. Check data/raw/corpus.csv or tab corpus paths.`;
        }
      } catch (err) {
        dot.className = "dot bad";
        text.textContent = `Backend unavailable: ${err.message}`;
      }
    }

    refreshStatus();
  </script>
</body>
</html>
